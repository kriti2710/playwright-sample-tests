name: Playwright Tests
on:
  workflow_dispatch:

jobs:
  playwright-run-e2es:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4, 5]
        shardTotal: [5]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/pnpm-install

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps

      - name: Run tests
        env:
          SHARD_INDEX: ${{ matrix.shardIndex }}
          SHARD_TOTAL: ${{ matrix.shardTotal }}
          TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}
        run: |
          echo "GitHub run attempt: ${{ github.run_attempt }}"

          # Case 1: Re-run failed jobs â†’ run only failed tests
          if [[ "${{ github.run_attempt }}" -gt 1 ]]; then
            echo "Detected re-run. Checking for failed tests metadata through TestDino."

            npx tdpw last-failed --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} > last-failed-flags.txt
            EXTRA_PW_FLAGS="$(cat last-failed-flags.txt)"

            if [[ -n "$EXTRA_PW_FLAGS" ]]; then
              echo "Failed tests found. Running only failed tests for this shard."
              echo "$EXTRA_PW_FLAGS"

              # IMPORTANT: preserve quotes
              eval "pnpm test:playwright $EXTRA_PW_FLAGS"
              exit 0
            fi

            echo "No failed test metadata found."
            echo "Previous attempt likely failed before playwright execution."
            echo "Falling back to full shard execution."
          fi

          # Case 2: Normal execution (first run)
          pnpm test:playwright --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
          exit 0

      - name: Upload blob report to GitHub Actions Artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: ./e2e-tests/blob-report
          retention-days: 1

      - name: Cache tdpw last failed metadata
        if: always()
        env:
          TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}
          SHARD_INDEX: ${{ matrix.shardIndex }}
          SHARD_TOTAL: ${{ matrix.shardTotal }}
        run: npx tdpw cache --verbose

  playwright-merge-reports:
    needs: [playwright-run-e2es]
    if: ${{ !cancelled() && needs.playwright-run-e2es.result != 'skipped' }}

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/pnpm-install

      - name: Download blob reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge Reports
        run: |
          cd e2e-tests
          pnpm exec playwright merge-reports --config=playwright-merge.config.ts ./all-blob-reports
          cd ..
          mv ./playwright-report .

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: Playwright Test Report
          path: ./playwright-report
          retention-days: 14

      - name: Send TestDino report
        #env:
         # NODE_ENV: staging
        run: |
          TESTDINO_RUNTIME="staging" npx --yes tdpw ./playwright-report \
           --token="${{ secrets.TESTDINO_TOKEN }}" \
           --upload-html \
           --upload-traces \
           --verbose



# # .github/workflows/playwright-daily.yml
# # Runs Playwright test shards every day at **11 : 42 AM IST** (06 : 12 UTC)
# # plus anytime you trigger it manually from the Actions tab.

# name: Run Playwright tests

# on:
#   push:          # runs on every push
#   pull_request:  # runs on new PRs or PR updates
#   schedule:
#     - cron: '30 3 * * 1-5'
#   workflow_dispatch:

# jobs:
#   run-tests:
#     name: Run shard ${{ matrix.shardIndex }}/5
#     runs-on: ubuntu-latest

#     strategy:
#       fail-fast: false
#       matrix:
#         shardIndex: [1,2,3,4,5] 
#         shardTotal: [5]

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node.js 18.x
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Create .env file
#         run: |
#           echo "USERNAME=${{ secrets.USERNAME }}" >> .env
#           echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
#           echo "NEW_PASSWORD=${{ secrets.NEW_PASSWORD }}" >> .env
#           echo "FIRST_NAME=${{ secrets.FIRST_NAME }}" >> .env
#           echo "STREET_NAME=${{ secrets.STREET_NAME }}" >> .env
#           echo "CITY=${{ secrets.CITY }}" >> .env
#           echo "STATE=${{ secrets.STATE }}" >> .env
#           echo "COUNTRY=${{ secrets.COUNTRY }}" >> .env
#           echo "ZIP_CODE=${{ secrets.ZIP_CODE }}" >> .env
     
#       - name: Cache npm dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.npm
#           key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
#           restore-keys: |
#             ${{ runner.os }}-node-

#       - name: Install deps + browsers
#         run: |
#           npm ci
#           npx playwright install --with-deps chromium firefox webkit

#       - name: List Playwright projects (debug)
#         run: npx playwright list --projects | cat

#       - name: Run shard ${{ matrix.shardIndex }} 
#         run: npx playwright test --grep="@chromium|@firefox|@webkit|@android|@ios" --reporter=blob --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

#       - name: Upload blob report
#         if: ${{ !cancelled() }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: blob-report-${{ matrix.shardIndex }}
#           path: ./blob-report
#           retention-days: 1

#   merge-reports:
#     name: Merge Reports
#     needs: run-tests
#     if: always()             # run even if some shards fail
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node.js 18.x
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Cache npm dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.npm
#           key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
#           restore-keys: |
#             ${{ runner.os }}-node-

#       - name: Install deps + browsers
#         run: |
#           npm ci
#           npx playwright install --with-deps

#       - name: Download all blob reports
#         uses: actions/download-artifact@v4
#         with:
#           path: ./all-blob-reports
#           pattern: blob-report-*
#           merge-multiple: true

#       - name: Merge HTML & JSON reports
#         run: npx playwright merge-reports --config=playwright.config.js ./all-blob-reports

#       - name: Upload combined report
#         uses: actions/upload-artifact@v4
#         with:
#           name: Playwright Test Report
#           path: ./playwright-report
#           retention-days: 14

#       # - name: Send TestDino report
#       #   env:
#       #     NODE_ENV: staging
#       #   # run: |
#       #   #  npx --yes tdpw ./playwright-report \
#       #   #    --token="${{ secrets.TESTDINO_TOKEN }}" \
#       #   #    --upload-html \
#       #   #    --upload-traces \
#       #   #    --verbose
#       - name: Send TestDino report
#         #env:
#          # NODE_ENV: staging
#         run: |
#           TESTDINO_RUNTIME="staging" npx --yes tdpw ./playwright-report \
#            --token="${{ secrets.TESTDINO_TOKEN }}" \
#            --upload-html \
#            --upload-traces \
#            --verbose