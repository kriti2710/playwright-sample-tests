name: Run Playwright tests

on:
  push:
  pull_request:
  schedule:
    - cron: '30 3 * * 1-5' # 11:00 AM IST
  workflow_dispatch:

jobs:
  run-tests:
    name: Run shard ${{ matrix.shardIndex }}/5
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4, 5]
        shardTotal: [5]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium firefox webkit

      - name: Run Playwright tests (always produce blobs)
        env:
          TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}
        run: |
          mkdir -p blob-report
          echo "GitHub run attempt: ${{ github.run_attempt }}"

          # ðŸ” Re-run only failed tests
          if [[ "${{ github.run_attempt }}" -gt 1 ]]; then
            npx tdpw last-failed --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} > failed-tests.txt || true
            FAILED_FLAGS=$(cat failed-tests.txt || true)

            if [[ -n "$FAILED_FLAGS" ]]; then
              pnpm exec playwright test \
                --reporter=blob \
                --output=blob-report \
                $FAILED_FLAGS || true
              exit 0
            fi
          fi

          # â–¶ï¸ First run (full shard)
          pnpm exec playwright test \
            --reporter=blob \
            --output=blob-report \
            --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} || true

      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: blob-report
          retention-days: 1

      - name: Cache TestDino metadata
        if: always()
        env:
          TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}
        run: npx tdpw cache --verbose || true

  playwright-merge-reports:
    name: Merge & Publish Reports
    needs: run-tests
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge HTML & JSON reports
        run: |
          pnpm exec playwright merge-reports \
            --reporter=html,json \
            all-blob-reports


      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Playwright Test Report
          path: playwright-report
          retention-days: 14

      - name: Send TestDino report
        env:
          NODE_ENV: 'production'
        run: |
          npx --yes tdpw ./playwright-report --token="${{ secrets.TESTDINO_TOKEN }}" --upload-html --upload-traces --verbose

      # ðŸ”´ FINAL GATE â€” FAIL PIPELINE IF TESTS FAILED
      - name: Fail pipeline if tests failed
        run: |
          FAILED=$(node -e "
            const r = require('./playwright-report/report.json');
            process.exit(r.stats.unexpected > 0 ? 1 : 0);
          ")





# # .github/workflows/playwright-daily.yml
# # Runs Playwright test shards every day at **11 : 42 AM IST** (06 : 12 UTC)
# # plus anytime you trigger it manually from the Actions tab.

# name: Run Playwright tests

# on:
#   push:          # runs on every push
#   pull_request:  # runs on new PRs or PR updates
#   schedule:
#     - cron: '30 3 * * 1-5'
#   workflow_dispatch:

# jobs:
#   run-tests:
#     name: Run shard ${{ matrix.shardIndex }}/5
#     runs-on: ubuntu-latest

#     strategy:
#       fail-fast: false
#       matrix:
#         shardIndex: [1,2,3,4,5] 
#         shardTotal: [5]

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node.js 18.x
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Create .env file
#         run: |
#           echo "USERNAME=${{ secrets.USERNAME }}" >> .env
#           echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
#           echo "NEW_PASSWORD=${{ secrets.NEW_PASSWORD }}" >> .env
#           echo "FIRST_NAME=${{ secrets.FIRST_NAME }}" >> .env
#           echo "STREET_NAME=${{ secrets.STREET_NAME }}" >> .env
#           echo "CITY=${{ secrets.CITY }}" >> .env
#           echo "STATE=${{ secrets.STATE }}" >> .env
#           echo "COUNTRY=${{ secrets.COUNTRY }}" >> .env
#           echo "ZIP_CODE=${{ secrets.ZIP_CODE }}" >> .env
     
#       - name: Cache npm dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.npm
#           key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
#           restore-keys: |
#             ${{ runner.os }}-node-

#       - name: Install deps + browsers
#         run: |
#           npm ci
#           npx playwright install --with-deps chromium firefox webkit

#       - name: List Playwright projects (debug)
#         run: npx playwright list --projects | cat

#       - name: Run shard ${{ matrix.shardIndex }} 
#         run: npx playwright test --grep="@chromium|@firefox|@webkit|@android|@ios" --reporter=blob --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

#       - name: Upload blob report
#         if: ${{ !cancelled() }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: blob-report-${{ matrix.shardIndex }}
#           path: ./blob-report
#           retention-days: 1

#   merge-reports:
#     name: Merge Reports
#     needs: run-tests
#     if: always()             # run even if some shards fail
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node.js 18.x
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Cache npm dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.npm
#           key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
#           restore-keys: |
#             ${{ runner.os }}-node-

#       - name: Install deps + browsers
#         run: |
#           npm ci
#           npx playwright install --with-deps

#       - name: Download all blob reports
#         uses: actions/download-artifact@v4
#         with:
#           path: ./all-blob-reports
#           pattern: blob-report-*
#           merge-multiple: true

#       - name: Merge HTML & JSON reports
#         run: npx playwright merge-reports --config=playwright.config.js ./all-blob-reports

#       - name: Upload combined report
#         uses: actions/upload-artifact@v4
#         with:
#           name: Playwright Test Report
#           path: ./playwright-report
#           retention-days: 14

#       # - name: Send TestDino report
#       #   env:
#       #     NODE_ENV: staging
#       #   # run: |
#       #   #  npx --yes tdpw ./playwright-report \
#       #   #    --token="${{ secrets.TESTDINO_TOKEN }}" \
#       #   #    --upload-html \
#       #   #    --upload-traces \
#       #   #    --verbose
#       - name: Send TestDino report
#         #env:
#          # NODE_ENV: staging
#         run: |
#           TESTDINO_RUNTIME="staging" npx --yes tdpw ./playwright-report \
#            --token="${{ secrets.TESTDINO_TOKEN }}" \
#            --upload-html \
#            --upload-traces \
#            --verbose