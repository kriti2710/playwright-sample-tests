name: Playwright Tests

on:
  workflow_dispatch:

jobs:
  playwright-run-e2es:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4, 5]
        shardTotal: [5]

    steps:
      # 1ï¸âƒ£ Checkout repository
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js (same idea as old YML)
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3ï¸âƒ£ Install pnpm (ðŸ”¥ missing step that caused failure)
      - name: Install pnpm
        run: npm install -g pnpm

      # 4ï¸âƒ£ Install dependencies (similar to npm ci in old YML)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5ï¸âƒ£ Install Playwright browsers
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      # 6ï¸âƒ£ Run tests with TestDino smart rerun logic
      - name: Run Playwright tests
        env:
          TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}
        run: |
          echo "GitHub run attempt: ${{ github.run_attempt }}"

          # ðŸ” SECOND RUN â†’ only failed tests
          if [[ "${{ github.run_attempt }}" -gt 1 ]]; then
            echo "Re-run detected. Fetching failed tests from TestDino..."

            npx tdpw last-failed --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} > failed-tests.txt
            FAILED_FLAGS=$(cat failed-tests.txt)

            if [[ -n "$FAILED_FLAGS" ]]; then
              echo "Running only failed tests:"
              echo "$FAILED_FLAGS"
              eval "pnpm test:playwright $FAILED_FLAGS"
              exit 0
            fi

            echo "No failed tests found, running full shard."
          fi

          # â–¶ï¸ FIRST RUN â†’ full shard execution
          pnpm test:playwright --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

      # 7ï¸âƒ£ Upload blob report
      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: e2e-tests/blob-report
          retention-days: 1

      # 8ï¸âƒ£ Cache TestDino metadata
      - name: Cache TestDino metadata
        if: always()
        env:
          TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}
        run: npx tdpw cache --verbose

  playwright-merge-reports:
    needs: playwright-run-e2es
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge Playwright reports
        run: |
          pnpm exec playwright merge-reports \
            --config=playwright-merge.config.ts \
            ./all-blob-reports
          mv playwright-report ./playwright-report

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: Playwright Test Report
          path: playwright-report
          retention-days: 14

      - name: Send report to TestDino
        run: |
          TESTDINO_RUNTIME="staging" npx --yes tdpw ./playwright-report \
            --token="${{ secrets.TESTDINO_TOKEN }}" \
            --upload-html \
            --upload-traces \
            --verbose




# # .github/workflows/playwright-daily.yml
# # Runs Playwright test shards every day at **11 : 42 AM IST** (06 : 12 UTC)
# # plus anytime you trigger it manually from the Actions tab.

# name: Run Playwright tests

# on:
#   push:          # runs on every push
#   pull_request:  # runs on new PRs or PR updates
#   schedule:
#     - cron: '30 3 * * 1-5'
#   workflow_dispatch:

# jobs:
#   run-tests:
#     name: Run shard ${{ matrix.shardIndex }}/5
#     runs-on: ubuntu-latest

#     strategy:
#       fail-fast: false
#       matrix:
#         shardIndex: [1,2,3,4,5] 
#         shardTotal: [5]

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node.js 18.x
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Create .env file
#         run: |
#           echo "USERNAME=${{ secrets.USERNAME }}" >> .env
#           echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
#           echo "NEW_PASSWORD=${{ secrets.NEW_PASSWORD }}" >> .env
#           echo "FIRST_NAME=${{ secrets.FIRST_NAME }}" >> .env
#           echo "STREET_NAME=${{ secrets.STREET_NAME }}" >> .env
#           echo "CITY=${{ secrets.CITY }}" >> .env
#           echo "STATE=${{ secrets.STATE }}" >> .env
#           echo "COUNTRY=${{ secrets.COUNTRY }}" >> .env
#           echo "ZIP_CODE=${{ secrets.ZIP_CODE }}" >> .env
     
#       - name: Cache npm dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.npm
#           key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
#           restore-keys: |
#             ${{ runner.os }}-node-

#       - name: Install deps + browsers
#         run: |
#           npm ci
#           npx playwright install --with-deps chromium firefox webkit

#       - name: List Playwright projects (debug)
#         run: npx playwright list --projects | cat

#       - name: Run shard ${{ matrix.shardIndex }} 
#         run: npx playwright test --grep="@chromium|@firefox|@webkit|@android|@ios" --reporter=blob --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

#       - name: Upload blob report
#         if: ${{ !cancelled() }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: blob-report-${{ matrix.shardIndex }}
#           path: ./blob-report
#           retention-days: 1

#   merge-reports:
#     name: Merge Reports
#     needs: run-tests
#     if: always()             # run even if some shards fail
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node.js 18.x
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Cache npm dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.npm
#           key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
#           restore-keys: |
#             ${{ runner.os }}-node-

#       - name: Install deps + browsers
#         run: |
#           npm ci
#           npx playwright install --with-deps

#       - name: Download all blob reports
#         uses: actions/download-artifact@v4
#         with:
#           path: ./all-blob-reports
#           pattern: blob-report-*
#           merge-multiple: true

#       - name: Merge HTML & JSON reports
#         run: npx playwright merge-reports --config=playwright.config.js ./all-blob-reports

#       - name: Upload combined report
#         uses: actions/upload-artifact@v4
#         with:
#           name: Playwright Test Report
#           path: ./playwright-report
#           retention-days: 14

#       # - name: Send TestDino report
#       #   env:
#       #     NODE_ENV: staging
#       #   # run: |
#       #   #  npx --yes tdpw ./playwright-report \
#       #   #    --token="${{ secrets.TESTDINO_TOKEN }}" \
#       #   #    --upload-html \
#       #   #    --upload-traces \
#       #   #    --verbose
#       - name: Send TestDino report
#         #env:
#          # NODE_ENV: staging
#         run: |
#           TESTDINO_RUNTIME="staging" npx --yes tdpw ./playwright-report \
#            --token="${{ secrets.TESTDINO_TOKEN }}" \
#            --upload-html \
#            --upload-traces \
#            --verbose